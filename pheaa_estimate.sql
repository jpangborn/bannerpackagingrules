-- NEW_PHEA
-- Sequence 1: EFC <= 4000

SELECT CASE 
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .45) > 4700 
  THEN FLOOR(ROUND(4700 * .8198)/2)*2
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .45) < 500 
  THEN 0 
  WHEN ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .45)/50)*50) * .8198) < 500
  THEN 500
  ELSE FLOOR(ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .45)/50)*50) * .8198)/2)*2 END
FROM RPTNEED
WHERE RPTNEED_EFC_AMT <= 4000
  AND RPTNEED_AIDY_CODE = :aidy
  AND RPTNEED_PIDM = :pidm

-- Sequence 2: EFC Between 4001 and 6000

SELECT CASE 
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .35) > 4700 
  THEN FLOOR(ROUND(4700 * .8198)/2)*2
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .35) < 500 
  THEN 0 
  WHEN ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .35)/50)*50) * .8198) < 500
  THEN 500
  ELSE FLOOR(ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .35)/50)*50) * .8198)/2)*2 END
FROM RPTNEED
WHERE RPTNEED_EFC_AMT BETWEEN 4001 AND 6000
  AND RPTNEED_AIDY_CODE = :aidy
  AND RPTNEED_PIDM = :pidm

-- Sequence 3: EFC Between 6001 and 8000

SELECT CASE 
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .20) > 4700 
  THEN FLOOR(ROUND(4700 * .8198)/2)*2 
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .20) < 500 
  THEN 0 
  WHEN ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .20)/50)*50) * .8198) < 500
  THEN 500
  ELSE FLOOR(ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .20)/50)*50) * .8198)/2)*2 END
FROM RPTNEED
WHERE RPTNEED_EFC_AMT BETWEEN 6001 AND 8000
  AND RPTNEED_AIDY_CODE = :aidy
  AND RPTNEED_PIDM = :pidm

-- Sequence 4: EFC Between 8001 and 10000

SELECT CASE 
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .10) > 4700 
  THEN FLOOR(ROUND(4700 * .8198)/2)*2 
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .10) < 500 
  THEN 0 
  WHEN ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .10)/50)*50) * .8198) < 500
  THEN 500
  ELSE FLOOR(ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .10)/50)*50) * .8198)/2)*2 END
FROM RPTNEED
WHERE RPTNEED_EFC_AMT BETWEEN 8001 AND 10000
  AND RPTNEED_AIDY_CODE = :aidy
  AND RPTNEED_PIDM = :pidm

-- Sequence 5: EFC Between 10001 and 12000

SELECT CASE 
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .05) > 4700 
  THEN FLOOR(ROUND(4700 * .8198)/2)*2
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .05) < 500 
  THEN 0 
  WHEN ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .05)/50)*50) * .8198) < 500
  THEN 500
  ELSE FLOOR(ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .05)/50)*50) * .8198)/2)*2 END
FROM RPTNEED
WHERE RPTNEED_EFC_AMT BETWEEN 10001 AND 12000
  AND RPTNEED_AIDY_CODE = :aidy
  AND RPTNEED_PIDM = :pidm

-- Sequence 6: EFC >= 12001

SELECT CASE 
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .02) > 4700 
  THEN FLOOR(ROUND(4700 * .8198)/2)*2
  WHEN ((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .02) < 500 
  THEN 0 
  WHEN ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .02)/50)*50) * .8198) < 500
  THEN 500
  ELSE FLOOR(ROUND((FLOOR(((31000 - (RPTNEED_EFC_AMT + NVL(RPKALGR.F_GET_FUND_OFFER(:aidy, :pidm, 'PELL', RPTNEED_SIMULATE_SW),0))) * .02)/50)*50) * .8198)/2)*2 END
FROM RPTNEED
WHERE RPTNEED_EFC_AMT >= 12001
  AND RPTNEED_AIDY_CODE = :aidy
  AND RPTNEED_PIDM = :pidm